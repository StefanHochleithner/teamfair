<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>⚽ TeamFair: Spieler bewerten & Teams</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: auto;
      padding: 1rem;
      background: #f7f9fc;
    }
    h1, h2 {
      text-align: center;
      color: #222;
    }
    label {
      display: block;
      margin: 0.6rem 0 0.2rem;
      font-weight: bold;
    }
    select, button {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .player-rating {
      background: white;
      padding: 0.6rem 1rem;
      margin-bottom: 0.4rem;
      border-radius: 6px;
      box-shadow: 0 1px 3px #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .player-name {
      font-weight: 600;
      font-size: 1.1rem;
    }
    select.rating-select {
      width: 60px;
      font-size: 1rem;
    }
    #teams {
      margin-top: 1.5rem;
      background: #e3f2fd;
      border-radius: 8px;
      padding: 1rem;
    }
    #teams > div {
      margin-bottom: 1rem;
    }
    #teams strong {
      font-size: 1.2rem;
      color: #0d47a1;
    }
  </style>
  <script src="data.js"></script>
</head>
<body>

  <h1>⚽ Spieler bewerten & Teams bilden</h1>

  <label for="matchday">Spieltag wählen:</label>
  <select id="matchday"></select>

  <div id="player-ratings"></div>

  <button id="saveBtn">Bewertung speichern</button>
  <button id="teamBtn">Teams generieren</button>

  <div id="teams"></div>

<script>
  // Funktion: Spieltage ab 28.07.2025 (Montags, Mittwochs)
  function getMatchdays(count = 20, startDate = new Date('2025-07-28')) {
    const days = [];
    let date = new Date(startDate);
    date.setHours(0,0,0,0);
    while (days.length < count) {
      if (date.getDay() === 1 || date.getDay() === 3) { // Montag oder Mittwoch
        days.push(new Date(date));
      }
      date.setDate(date.getDate() + 1);
    }
    return days;
  }

  // Format Datum für Anzeige: Wochentag, dd.mm.yyyy
  function formatDate(date) {
    return date.toLocaleDateString('de-AT', { weekday: 'long', day:'2-digit', month:'2-digit', year:'numeric' });
  }

  // Lade Spieltage ins Dropdown
  function populateMatchdays() {
    const select = document.getElementById('matchday');
    select.innerHTML = '';
    const matchdays = getMatchdays();
    matchdays.forEach(day => {
      const option = document.createElement('option');
      option.value = day.toISOString().slice(0,10);
      option.textContent = formatDate(day);
      select.appendChild(option);
    });
  }

  // Spieler laden, die für den Spieltag im Admin ausgewählt wurden
  function getPlayersForMatchday(dateISO) {
    const raw = localStorage.getItem('approved_players_' + dateISO);
    if (!raw) return [];
    try {
      return JSON.parse(raw);
    } catch {
      return [];
    }
  }

  // Ratings für Spieltag laden
  function loadRatings(dateISO) {
    const raw = localStorage.getItem('ratings_' + dateISO);
    if (!raw) return {};
    try {
      return JSON.parse(raw);
    } catch {
      return {};
    }
  }

  // Anzeigen der Spieler + Bewertungsselect
  function renderPlayerRatings() {
    const dateISO = document.getElementById('matchday').value;
    const players = getPlayersForMatchday(dateISO);
    const ratings = loadRatings(dateISO);
    const container = document.getElementById('player-ratings');
    container.innerHTML = '';

    if (players.length === 0) {
      container.innerHTML = '<p>⚠️ Für diesen Spieltag wurden noch keine Spieler ausgewählt.</p>';
      return;
    }

    players.forEach(name => {
      const div = document.createElement('div');
      div.className = 'player-rating';
      div.innerHTML = `
        <div class="player-name">${name}</div>
        <select class="rating-select" id="rating-${name}">
          <option value="1" ${ratings[name]==1 ? 'selected' : ''}>1 (sehr gut)</option>
          <option value="2" ${ratings[name]==2 ? 'selected' : ''}>2</option>
          <option value="3" ${(!ratings[name] || ratings[name]==3) ? 'selected' : ''}>3</option>
          <option value="4" ${ratings[name]==4 ? 'selected' : ''}>4</option>
          <option value="5" ${ratings[name]==5 ? 'selected' : ''}>5 (schlecht)</option>
        </select>
      `;
      container.appendChild(div);
    });
  }

  // Bewertungen speichern
  function saveRatings() {
    const dateISO = document.getElementById('matchday').value;
    const players = getPlayersForMatchday(dateISO);
    if (players.length === 0) {
      alert('Keine Spieler für diesen Spieltag ausgewählt.');
      return;
    }
    const ratings = {};
    let valid = true;

    players.forEach(name => {
      const sel = document.getElementById('rating-' + name);
      if (!sel) return;
      const val = parseInt(sel.value);
      if (isNaN(val) || val < 1 || val > 5) valid = false;
      ratings[name] = val;
    });

    if (!valid) {
      alert('Bitte alle Spieler bewerten mit Werten zwischen 1 und 5.');
      return;
    }

    localStorage.setItem('ratings_' + dateISO, JSON.stringify(ratings));
    alert('✅ Bewertungen gespeichert!');
  }

  // Teams bilden: balanciert nach Bewertungen
  function generateTeams() {
    const dateISO = document.getElementById('matchday').value;
    const ratings = loadRatings(dateISO);
    const players = Object.keys(ratings);

    if (players.length < 2) {
      alert('Mindestens 2 Spieler mit Bewertungen nötig, um Teams zu bilden.');
      return;
    }

    // Sortiere Spieler nach Bewertung (1=best, 5=schlecht)
    players.sort((a,b) => ratings[a] - ratings[b]);

    // Fairer Team-Split: Spieler reihum auf Teams verteilen
    const teamA = [];
    const teamB = [];
    players.forEach((player, i) => {
      if (i % 2 === 0) teamA.push(player);
      else teamB.push(player);
    });

    // Ausgabe
    const container = document.getElementById('teams');
    container.innerHTML = `
      <div><strong>Team A:</strong><br>${teamA.join('<br>')}</div>
      <div><strong>Team B:</strong><br>${teamB.join('<br>')}</div>
    `;
  }

  document.getElementById('matchday').addEventListener('change', () => {
    renderPlayerRatings();
    document.getElementById('teams').innerHTML = '';
  });

  document.getElementById('saveBtn').addEventListener('click', saveRatings);
  document.getElementById('teamBtn').addEventListener('click', generateTeams);

  // Buttons: Alternative EventListener wenn nicht via IDs
  document.getElementById('saveBtn').onclick = saveRatings;
  document.getElementById('teamBtn').onclick = generateTeams;

  // Initial
  populateMatchdays();
  renderPlayerRatings();

</script>

</body>
</html>
